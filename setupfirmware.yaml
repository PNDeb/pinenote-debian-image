{{- $architecture := or .architecture "arm64" -}}
{{- $prevtargz := or .prevtargz "baseprograms.tar.gz" }}
{{- $targz := or .targz "addkernel.tar.gz" }}

architecture: {{ $architecture }}

actions:
  - action: unpack
    file: {{ $prevtargz }}

  - action: overlay
    description: Copy helper command /boot
    source: overlays/boot/
    destination: /boot/

  - action: run
    description: Untar and copy original firmware
    command: tar xzf ${RECIPEDIR}/overlays/firmware/original-firmware.tar.gz -C ${ROOTDIR}/usr/lib/

  - action: run
    description: Copy the waveform
    command: cp ${RECIPEDIR}/overlays/firmware/waveform.bin ${ROOTDIR}/usr/lib/firmware/

  - action: run
    command: mkdir ${ROOTDIR}/usr/lib/firmware/rockchip

  - action: run
    command: cp ${RECIPEDIR}/overlays/firmware/waveform.bin ${ROOTDIR}/usr/lib/firmware/rockchip/ebc.wbf

  - action: run
    description: Prepare brcm firmware files
    chroot: true
    script: scripts/setup-brcm-firmware.sh /usr/lib/firmware/

  - action: pack
    file: {{ $targz }}

